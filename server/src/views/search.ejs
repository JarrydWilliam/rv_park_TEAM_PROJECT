<!doctype html>
<html lang="en">
  <head>
    <%- include('partials/head') %>
  </head>
  <body>
    <%- include('partials/nav') %>

    <header class="page-hero">
      <div class="container">
        <h1 class="display-6 fw-semibold mb-1">Find a Site</h1>
        <p class="text-muted mb-0">Search by dates, rig length, and site type.</p>
      </div>
    </header>

    <main class="container py-4">
      <section class="card card-elevated">
        <div class="card-body">
          <% if (error) { %>
            <div class="alert alert-danger mb-4">
              <i class="bi bi-exclamation-triangle me-2"></i><%= error %>
            </div>
          <% } %>

          <% 
            const minLen = (rigBounds && rigBounds.minLen) || 1;
            const maxLen = (rigBounds && rigBounds.maxLen) || 100;
          %>

          <form method="get" action="/search" class="row g-3 align-items-end">
            <div class="col-md-3">
              <label class="form-label">Check-in</label>
              <input
                type="date"
                name="check_in"
                class="form-control"
                value="<%= (query && query.check_in) || '' %>"
                required
              >
            </div>
            <div class="col-md-3">
              <label class="form-label">Check-out</label>
              <input
                type="date"
                name="check_out"
                class="form-control"
                value="<%= (query && query.check_out) || '' %>"
                required
              >
            </div>
            <div class="col-md-3">
              <label class="form-label">Rig length (ft)</label>
              <input
                type="number"
                name="rig_length"
                class="form-control"
                min="<%= minLen %>"
                max="<%= maxLen %>"
                value="<%= (query && query.rig_length) || '' %>"
                required
              >
              <div class="form-text">
                Allowed range: <%= minLen %>â€“<%= maxLen %> ft.
              </div>
            </div>
            <div class="col-md-2">
              <label class="form-label">Site type</label>
              <select name="type" class="form-select">
                <option value="" <%= (!query || !query.type) ? 'selected' : '' %> >Any</option>
                <option value="STANDARD" <%= (query && query.type==='STANDARD') ? 'selected' : '' %> >STANDARD</option>
                <option value="TENT"     <%= (query && query.type==='TENT') ? 'selected' : '' %> >TENT</option>
                <option value="DRY"      <%= (query && query.type==='DRY') ? 'selected' : '' %> >DRY</option>
                <option value="TRAILER"  <%= (query && query.type==='TRAILER') ? 'selected' : '' %> >TRAILER</option>
              </select>
            </div>
            <div class="col-md-1 d-grid">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-search"></i>
              </button>
            </div>
          </form>
        </div>
      </section>

      <% if (results && results.length) { %>
        <section class="mt-4">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h2 class="h5 mb-0">
              Available Sites
              <span class="text-muted fw-normal">(<%= results.length %>)</span>
            </h2>
          </div>

          <div class="table-responsive card card-elevated">
            <table class="table table-dark table-hover table-striped align-middle mb-0">
              <thead>
                <tr>
                  <th class="w-25">#</th>
                  <th>Type</th>
                  <th>Length (ft)</th>
                  <th>Status</th>
                  <th class="text-end">Action</th>
                </tr>
              </thead>
              <tbody>
                <% results.forEach(s => { %>
                  <tr>
                    <td class="fw-medium"><%= s.number %></td>
                    <td>
                      <span class="badge rounded-pill bg-surface border text-body">
                        <%= s.type %>
                      </span>
                    </td>
                    <td><%= s.lengthFt %></td>
                    <td>
                      <span class="badge bg-success-subtle text-success-emphasis border border-success-subtle">
                        Available
                      </span>
                    </td>
                    <td class="text-end">
                      <form method="get" action="/reserve/new" class="d-inline">
                        <input type="hidden" name="siteId" value="<%= s.id %>">
                        <input type="hidden" name="check_in" value="<%= query.check_in %>">
                        <input type="hidden" name="check_out" value="<%= query.check_out %>">
                        <input type="hidden" name="rig_length" value="<%= query.rig_length %>">
                        <input type="hidden" name="type" value="<%= query.type || '' %>">
                        <button type="submit" class="btn btn-sm btn-primary">
                          Reserve
                        </button>
                      </form>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        </section>
      <% } else if (query && Object.keys(query).length && !error) { %>
        <p class="text-muted mt-4">No sites matched your search.</p>
      <% } %>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
