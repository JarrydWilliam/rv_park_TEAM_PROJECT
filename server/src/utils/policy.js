const { differenceInCalendarDays } = require('date-fns'); const prisma = require('../db/prisma'); function toDate(v){return v instanceof Date?v:new Date(v);} function nightsBetween(a,b){const d1=toDate(a), d2=toDate(b); return Math.max(0,differenceInCalendarDays(d2,d1));} function withinPeak(date){const d=toDate(date); const y=d.getUTCFullYear(); const start=new Date(Date.UTC(y,3,15)); const end=new Date(Date.UTC(y,9,15)); return (d>=start && d<=end);} async function activeRateFor(siteType,onDate){ const rate=await prisma.ratePlan.findFirst({where:{siteType, effectiveFrom:{lte:toDate(onDate)}, effectiveTo:{gte:toDate(onDate)}}, orderBy:{effectiveFrom:'desc'}}); return rate?.amount?Number(rate.amount):30.00;} async function stayTouchesSpecialEvent(i,o){ const events=await prisma.specialEvent.findMany({where:{startDate:{lt:toDate(o)}, endDate:{gt:toDate(i)}}}); return events.length>0;} function overlapFilter(i,o){ return { status:'CONFIRMED', AND:[{checkIn:{lt:toDate(o)}},{checkOut:{gt:toDate(i)}}]}; } module.exports={toDate,nightsBetween,withinPeak,activeRateFor,stayTouchesSpecialEvent,overlapFilter};